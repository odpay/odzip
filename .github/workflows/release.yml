name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

env:
  BUILD_TYPE: Release

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-latest
            name: darwin-universal
            cmake_extra: -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"
          - os: ubuntu-latest
            name: linux-amd64
            cmake_extra: ""
          - os: windows-latest
            name: windows-amd64
            cmake_extra: ""

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DODZ_PORTABLE=ON ${{ matrix.cmake_extra }}

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Test
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target run

      - name: Package (unix)
        if: runner.os != 'Windows'
        run: |
          mkdir odz-${{ matrix.name }}
          cp build/odz odz-${{ matrix.name }}/
          cp LICENSE odz-${{ matrix.name }}/
          tar czf odz-${{ matrix.name }}.tar.gz odz-${{ matrix.name }}

      - name: Package (windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir odz-${{ matrix.name }}
          cp build/${{ env.BUILD_TYPE }}/odz.exe odz-${{ matrix.name }}/
          cp LICENSE odz-${{ matrix.name }}/
          7z a odz-${{ matrix.name }}.zip odz-${{ matrix.name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: odz-${{ matrix.name }}
          path: odz-${{ matrix.name }}.*

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            odz-darwin-universal.tar.gz
            odz-linux-amd64.tar.gz
            odz-windows-amd64.zip

  update-aur:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update AUR package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          SHA=$(curl -sL "https://github.com/odpay/odzip/archive/${GITHUB_REF_NAME}.tar.gz" | sha256sum | cut -d' ' -f1)

          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          echo -e "Host aur.archlinux.org\n  IdentityFile ~/.ssh/aur\n  User aur\n  StrictHostKeyChecking no" > ~/.ssh/config

          git clone ssh://aur@aur.archlinux.org/odzip.git aur-repo
          cd aur-repo

          cat > PKGBUILD << 'EOF'
          # Maintainer: odpay <https://github.com/odpay>
          pkgname=odzip
          pkgver=VERSION_PH
          pkgrel=1
          pkgdesc='Minimal file compression using LZ77 hash-chain matching and Huffman coding'
          arch=('x86_64')
          url='https://github.com/odpay/odzip'
          license=('MIT')
          depends=('glibc')
          provides=('odz')
          makedepends=('cmake')
          source=("$pkgname-$pkgver.tar.gz::https://github.com/odpay/odzip/archive/v$pkgver.tar.gz")
          sha256sums=('SHA_PH')

          build() {
              cmake -B build -S "$pkgname-$pkgver" \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DCMAKE_INSTALL_PREFIX=/usr \
                  -DODZ_PORTABLE=ON
              cmake --build build
          }

          check() {
              cmake --build build --target run
          }

          package() {
              DESTDIR="$pkgdir" cmake --install build
              install -Dm644 "$pkgname-$pkgver/LICENSE" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
          }
          EOF

          sed -i 's/^          //' PKGBUILD
          sed -i "s/VERSION_PH/${VERSION}/g" PKGBUILD
          sed -i "s/SHA_PH/${SHA}/g" PKGBUILD

          # generate .SRCINFO
          cat > .SRCINFO << SRCINFO
          pkgbase = odzip
          	pkgdesc = Minimal file compression using LZ77 hash-chain matching and Huffman coding
          	pkgver = ${VERSION}
          	pkgrel = 1
          	url = https://github.com/odpay/odzip
          	arch = x86_64
          	license = MIT
          	makedepends = cmake
          	depends = glibc
          	provides = odz
          	source = odzip-${VERSION}.tar.gz::https://github.com/odpay/odzip/archive/v${VERSION}.tar.gz
          	sha256sums = ${SHA}

          pkgname = odzip
          SRCINFO
          sed -i 's/^          //' .SRCINFO

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add PKGBUILD .SRCINFO
          git commit -m "Update to ${VERSION}"
          git push

  update-tap:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tap repo
        uses: actions/checkout@v4
        with:
          repository: odpay/homebrew-tap
          token: ${{ secrets.TAP_GITHUB_TOKEN }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Update formula
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          SHA_DARWIN=$(sha256sum odz-darwin-universal.tar.gz | cut -d' ' -f1)
          SHA_LINUX=$(sha256sum odz-linux-amd64.tar.gz | cut -d' ' -f1)

          cat > Formula/odz.rb << 'FORMULA'
          class Odz < Formula
            desc "DEFLATE-class LZ77+Huffman compressor"
            homepage "https://github.com/odpay/odzip"
            version "VERSION_PLACEHOLDER"
            license "MIT"

            on_macos do
              url "https://github.com/odpay/odzip/releases/download/vVERSION_PLACEHOLDER/odz-darwin-universal.tar.gz"
              sha256 "SHA_DARWIN_PLACEHOLDER"
            end

            on_linux do
              url "https://github.com/odpay/odzip/releases/download/vVERSION_PLACEHOLDER/odz-linux-amd64.tar.gz"
              sha256 "SHA_LINUX_PLACEHOLDER"
            end

            def install
              bin.install "odz"
            end

            test do
              (testpath/"input.txt").write("hello world")
              system bin/"odz", "c", "input.txt", "output.odz"
              system bin/"odz", "d", "output.odz", "roundtrip.txt"
              assert_equal "hello world", (testpath/"roundtrip.txt").read
            end
          end
          FORMULA

          sed -i 's/^          //' Formula/odz.rb
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" Formula/odz.rb
          sed -i "s/SHA_DARWIN_PLACEHOLDER/${SHA_DARWIN}/g" Formula/odz.rb
          sed -i "s/SHA_LINUX_PLACEHOLDER/${SHA_LINUX}/g" Formula/odz.rb

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/odz.rb
          git commit -m "odz ${GITHUB_REF_NAME}"
          git push
